# ===============================================================
#          1. 中央伺服器設定 (最終標記翻譯版)
# ===============================================================
# 檔案路徑範例: /etc/wireguard/wg0.conf

[Interface]
PrivateKey = JughSF9lB/BzHl2uDUU3KC04iR6qxc07Xyua61XiLc4=
Address = 10.10.0.1/24
ListenPort = 51820
SaveConfig = true

# PostUp/PostDown 是本方案的魔法核心
# 1. MARK: 為來自B組(10.10.0.3)的連線，蓋上一個獨一無二的「郵戳」(標記0x2)
# 2. FORWARD: 允許VPN內部流量自由轉發
# 3. DNAT (去程翻譯): 將發往虛擬B區(51.x)的流量，目標地址翻譯成真實B區(50.x)
# 4. SNAT (回程翻譯): 檢查郵戳！如果流量來自真實的50.x，且帶有B組的郵戳，
#    就將其來源地址翻譯回虛擬的51.x
# 5. MASQUERADE: 允許所有客戶端通過伺服器上網
PostUp = iptables -t mangle -A PREROUTING -i %i -s 10.10.0.3/32 -j CONNMARK --set-mark 0x2; \
         iptables -t mangle -A POSTROUTING -j CONNMARK --restore-mark; \
         iptables -A FORWARD -i %i -j ACCEPT; \
         iptables -t nat -A POSTROUTING -d 192.168.51.0/24 -o %i -j NETMAP --to 192.168.50.0/24; \
         iptables -t nat -A PREROUTING -s 192.168.50.0/24 -i %i -m connmark --mark 0x2 -j NETMAP --to 192.168.51.0/24; \
         iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -t mangle -D PREROUTING -i %i -s 10.10.0.3/32 -j CONNMARK --set-mark 0x2; \
           iptables -t mangle -D POSTROUTING -j CONNMARK --restore-mark; \
           iptables -D FORWARD -i %i -j ACCEPT; \
           iptables -t nat -D POSTROUTING -d 192.168.51.0/24 -o %i -j NETMAP --to 192.168.50.0/24; \
           iptables -t nat -D PREROUTING -s 192.168.50.0/24 -i %i -m connmark --mark 0x2 -j NETMAP --to 192.168.51.0/24; \
           iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE


# --- Peer A: 模組001 (A區) ---
[Peer]
PublicKey = KXnnuuRXkKKjtGelpUDqkRObuwbjT7FjXoef8lnJqXs=
PresharedKey = cG4tCWuOVMscDKe7+Vy6Kggf+tRzIYEpFDOyINTuJV0=
# 伺服器的路由表：A區對應真實的 50 網段
AllowedIPs = 10.10.0.2/32, 192.168.50.0/24
PersistentKeepalive = 25

# --- Peer B: 模組002 (B區) ---
[Peer]
PublicKey = PL2l2IzjLnrF1Voncr0yEXXW3amsnDlVKxwX1NqhjVQ=
PresharedKey = p97KRZhCTdV5+f6FuJYkr9oQkBWP+Oo1PD1Ed9RIGaE=
# 【核心修正】伺服器的路由表：B區對應虛擬的 51 網段，路由不再衝突！
AllowedIPs = 10.10.0.3/32, 192.168.51.0/24
PersistentKeepalive = 25

# --- Peer C: 使用者客戶端 ---
[Peer]
# User: fanmm-mac
PublicKey = xLYtvfP4qC9z9dpjIEOZ1tZGJFGp/IJXd4Ecm0j9UXU=
AllowedIPs = 10.10.0.6/32
PresharedKey = ZfDwi2jIPQ1C+Lw/jmaVA7mmqvh3PZuqZjGH4BD4TRM=
PersistentKeepalive = 25